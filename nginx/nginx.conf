worker_processes auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  sendfile      on;
  server_tokens off;

  # Keepalive upstream to FastAPI
  upstream api_upstream {
    server api:8000;
    keepalive 16;
  }

  # (Optional) for websocket-style Upgrade headers; harmless to keep
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;

    # --- Streaming endpoint (SSE) ---
    # NOTE: This must come before the generic /api/ block.
    location /api/query/stream {
      proxy_pass         http://api_upstream/query/stream;
      proxy_http_version 1.1;

      proxy_set_header   Host $host;
      proxy_set_header   X-Forwarded-Proto $scheme;
      proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;

      # keepalive to upstream; do NOT set "Upgrade" here (SSE is plain HTTP)
      proxy_set_header   Connection "";

      # crucial for streaming
      proxy_buffering    off;
      proxy_read_timeout 3600s;

      # extra hint to disable buffering in some setups
      add_header X-Accel-Buffering no;
      add_header Cache-Control "no-store" always;
    }

    # --- General API (everything else under /api/) ---
    location /api/ {
      proxy_pass         http://api_upstream/;
      proxy_http_version 1.1;

      proxy_set_header   Host $host;
      proxy_set_header   X-Forwarded-Proto $scheme;
      proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header   Connection "";

      # friendly to long requests & streaming JSON
      proxy_buffering    off;
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;

      # harmless if the client ever upgrades (e.g., websockets)
      proxy_set_header   Upgrade $http_upgrade;

      # prevent edge caching
      add_header Cache-Control "no-store" always;
    }

    # --- Static SPA ---
    # try files first; fall back to index.html (client-side routing)
    location / {
      try_files $uri /index.html;
    }

    # cache-bust static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff2?)$ {
      expires 7d;
      access_log off;
    }

    client_max_body_size 16m;
  }
}
